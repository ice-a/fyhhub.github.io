(window.webpackJsonp=window.webpackJsonp||[]).push([[101],{407:function(e,a,s){"use strict";s.r(a);var t=s(11),n=function(e){e.options.__data__block__={mermaid_1a962853:"flowchart TB;\n  a(Module._resolveFilename) --\x3e b{是否为内置模块}\n  b --\x3e |否|d(Module._resolveLookupPaths, 将paths和环境变量node_modules合并)\n  b --\x3e |是|c(End)\n  d --\x3e f(Module._findPath,在paths中解析模块的真实路径)\n  f --\x3e c\n",mermaid_382ee165:"flowchart TB;\n  a(Module._findPath) --\x3e b{查询缓存}\n  b --\x3e |是|c(直接返回结果)\n  c --\x3e d(End)\n  b --\x3e |否|e(遍历paths,合并path和request)\n  e --\x3e f{文件是否存在}\n  f --\x3e |否|e\n  f --\x3e |是|g(调用toRealPath生成真实路径)\n  g --\x3e h{路径是否存在}\n  h --\x3e |是|d\n  h --\x3e |否|e\n"}},o=Object(t.a)({},(function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"module模块使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#module模块使用"}},[e._v("#")]),e._v(" module模块使用")]),e._v(" "),s("h2",{attrs:{id:"resolvefilename"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#resolvefilename"}},[e._v("#")]),e._v(" _resolveFilename")]),e._v(" "),s("p",[s("strong",[e._v("作用：解析模块的真实路径，例如相对路径解析为绝对路径。")])]),e._v(" "),s("Mermaid",{attrs:{id:"mermaid_1a962853",graph:e.$dataBlock.mermaid_1a962853}}),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" parent "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  id"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" fromFile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 文件路径")]),e._v("\n  filename"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" fromFile"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 文件路径")]),e._v("\n  paths"),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v(":")]),e._v(" Module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("_nodeModulePaths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("fromDir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 获取所有node_modules可能的位置")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// 第二个参数实际上是父模块对象")]),e._v("\nModule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("_resolveFilename")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("moduleId"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" parent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("h2",{attrs:{id:"nodemodulepaths"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#nodemodulepaths"}},[e._v("#")]),e._v(" _nodeModulePaths")]),e._v(" "),s("p",[e._v("作用：生成node_modules可能的路径，例如")]),e._v(" "),s("div",{staticClass:"language-js line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[e._v("Module"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("_nodeModulePaths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("fromDir"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// fromDir: /home/yuangong/tmp")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// [ '/home/yuangong/tmp/node_modules',")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// '/home/yuangong/node_modules',")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// '/home/node_modules',")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// '/node_modules' ]")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("h2",{attrs:{id:"findpath"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#findpath"}},[e._v("#")]),e._v(" _findPath")]),e._v(" "),s("Mermaid",{attrs:{id:"mermaid_382ee165",graph:e.$dataBlock.mermaid_382ee165}}),s("h2",{attrs:{id:"node模块解析流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#node模块解析流程"}},[e._v("#")]),e._v(" Node模块解析流程")]),e._v(" "),s("ul",[s("li",[s("p",[e._v("Nodejs项目模块路径解析是通过"),s("code",[e._v("require.resolve")]),e._v("方法来实现的")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("require.resolve")]),e._v("就是通过"),s("code",[e._v("Module.resolveFileName")]),e._v(" 方法实现的")])]),e._v(" "),s("li",[s("p",[s("code",[e._v("require.resolve")]),e._v("实现原理:")]),e._v(" "),s("ul",[s("li",[s("p",[s("code",[e._v("Module.resolveFileName")]),e._v("方法核心流程有3点:")]),e._v(" "),s("ul",[s("li",[e._v("判断是否为内置模块")]),e._v(" "),s("li",[e._v("通过"),s("code",[e._v("ModuleresolveLookupPaths")]),e._v("方法生成"),s("code",[e._v("node_modules")]),e._v("可能存在的路径")]),e._v(" "),s("li",[e._v("通过"),s("code",[e._v("Module.findPath")]),e._v("查询模块的真实路径")])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("Module.findPath")]),e._v("核心流程有4点:")]),e._v(" "),s("ul",[s("li",[e._v("查询缓存(将"),s("code",[e._v("request和paths")]),e._v("通过"),s("code",[e._v("\\x00")]),e._v("合并成cacheKey)")]),e._v(" "),s("li",[e._v("遍历paths将"),s("code",[e._v("path与request")]),e._v("组成文件路径"),s("code",[e._v("basePath")])]),e._v(" "),s("li",[e._v("如果"),s("code",[e._v("basePath")]),e._v("存在则调用"),s("code",[e._v("fs.realPathSync")]),e._v("获取文件真实路径")]),e._v(" "),s("li",[e._v("将文件真实路径缓存到"),s("code",[e._v("Module.pathCache")]),e._v("(key就是前面生成的cacheKey)。")])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("fs.realPathSync")]),e._v("核心流程有3点:")]),e._v(" "),s("ul",[s("li",[e._v("查询缓存(缓存的key为p即"),s("code",[e._v("Module.findPath")]),e._v("中生成的文件路径) 更多课程街")]),e._v(" "),s("li",[e._v("从左往右遍历路径字符串，查询到"),s("code",[e._v("/")]),e._v("时，拆分路径，判断该路径是否为软链接，如果是软链接则查询真实链接，并生成新路径p然后继续往后遍历，这里有1个细节需要特别注意:\n"),s("ul",[s("li",[e._v("遍历过程中生成的子路径base会缓存在knownHard和cache中，避免重复查询")])])]),e._v(" "),s("li",[e._v("遍历完成得到模块对应的真实路径，此时会将原始路路径original作为key，真实路径作为value，保存到缓存中")])])])])]),e._v(" "),s("li",[s("p",[s("code",[e._v("require.resolve.paths")]),e._v("等价于"),s("code",[e._v("Module.resolveLookupPaths")]),e._v("，该方法用于获取所有"),s("code",[e._v("node_modules")])]),e._v(" "),s("ul",[s("li",[e._v("如果路径为/(根目录)，直接返回"),s("code",[e._v("['/node_modules']")])]),e._v(" "),s("li",[e._v("否则，将路径字符串从后往前遍历，查询到/时，拆分路径，在后面加上"),s("code",[e._v("node_modules")]),e._v("，并传入一个"),s("code",[e._v("paths")]),e._v("数组，直至查询不到"),s("code",[e._v("/")]),e._v("后返回"),s("code",[e._v("paths")]),e._v("数组")])])])])],1)}),[],!1,null,null,null);"function"==typeof n&&n(o);a.default=o.exports}}]);