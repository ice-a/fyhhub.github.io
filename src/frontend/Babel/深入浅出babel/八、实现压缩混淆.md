# 八、实现压缩混淆

**index.js**

```js
const { transformFromAstSync } = require('@babel/core');
const  parser = require('@babel/parser');
const manglePlugin = require('./mangle');
const compressPlugin = require('./compress');

const sourceCode = `
  function func() {
    const num1 = 1;
    const num2 = 2;
    const num3 = /*@__PURE__*/add(1, 2);
    const num4 = add(3, 4);
    console.log(num2);
    return num2;
    console.log(num1);
    function add (aaa, bbb) {
      return aaa + bbb;
    }
  }
  func();
`;

const ast = parser.parse(sourceCode, {
  sourceType: 'unambiguous',
  comments: true
});

const { code } = transformFromAstSync(ast, sourceCode, {
    plugins: [
      [manglePlugin],
      [compressPlugin]
    ],
    generatorOpts: {
      comments: false,
      compact: true
    }
});
console.log(code);
```



**compress.js**

```js
const { declare } = require('@babel/helper-plugin-utils');

function canExistAfterCompletion(path) {
  return path.isFunctionDeclaration() || path.isVariableDeclaration({
    kind: "var"
  });
}

const compress = declare((api, options, dirname) => {
  api.assertVersion(7);

  return {
    pre(file) {
      file.set('uid', 0);
    },
    visitor: {
      BlockStatement(path) {
        const statementPaths = path.get('body');
        let purge = false;
        // 遍历函数块ast
        for (let i = 0; i < statementPaths.length; i++) {
          // 如果是return, throw, continue, break
          if (statementPaths[i].isCompletionStatement()) {
            purge = true;
            continue;
          }
          // 已经找到了完成语句，如果不是var, function类型的节点（函数和变量会提升），就直接删除
          if (purge && !canExistAfterCompletion(statementPaths[i])) {
            statementPaths[i].remove();
          }
        }
      },
      Scopable(path) {
        // 遍历当前作用域所有的变量节点
        Object.entries(path.scope.bindings).forEach(([key, binding]) => {
          // 发现这个变量没有被引用
          if (!binding.referenced) {
            // 判断这个变量的值是不是一个函数调用 例如
            // function a {
            //   console.log('a');
            //   return 'aa';
            // }
            // const b = a();
            if (binding.path.get('init').isCallExpression()) {
              // 判断函数前面 是不是有  /*#__PURE__*/ 代表是一个没有副作用的函数，可以被直接删除
              const comments = binding.path.get('init').node.leadingComments;
              if (comments && comments[0]) {
                if (comments[0].value.includes('PURE')) {
                  binding.path.remove();
                  return;
                }
              }
            }
            // 使用内置的isPure判断是否有副作用，如果没有就删除变量的声明
            if (!path.scope.isPure(binding.path.node.init)) {
              binding.path.parentPath.replaceWith(api.types.expressionStatement(binding.path.node.init));

            // 存在副作用，直接删除整条语句
            } else {
              binding.path.remove();
            }
          }
        });
      }
    }
  }
});

module.exports = compress;
```


**mangle.js**

```js
const { declare } = require('@babel/helper-plugin-utils');

const base54 = (function(){
    var DIGITS = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ$_";
    return function(num) {
      var ret = "";
      do {
        ret = DIGITS.charAt(num % 54) + ret;
        num = Math.floor(num / 54);
      } while (num > 0);
      return ret;
    };
})();

const mangle = declare((api, options, dirname) => {
    api.assertVersion(7);

    return {
      pre(file) {
        file.set('uid', 0);
      },
      visitor: {
        Scopable: {
          exit(path, state) {
            let uid = state.file.get('uid');
            // 遍历当前作用域所有变量
            Object.entries(path.scope.bindings).forEach(([key, binding]) => {
                // 如果变量名 已经混淆过 直接return
                if(binding.mangled) return;
                // 标记变量名被混淆
                binding.mangled = true;
                // 生成一个唯一id
                const newName = path.scope.generateUid(base54(uid++));
                // 变量重命名
                binding.path.scope.rename(key, newName)
            });
            state.file.set('uid', uid);
          }
        }
      }
    }
});

module.exports = mangle;
```

::: tip
所有文章均参考或直接拷贝于[Babel 插件通关秘籍](https://juejin.cn/book/6946117847848321055)
强烈推荐购买阅读
:::